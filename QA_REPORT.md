# Отчёт QA по проекту AndreyVPN_bot (2026-02-24)

## 1. Сводка ошибок по Severity

| Severity | Описание | Статус |
| :--- | :--- | :--- |
| **CRITICAL** | **135+ синтаксических ошибок** в хендлерах (неправильные многострочные строки и f-строки). Бот не запускался. | **ИСПРАВЛЕНО** |
| **CRITICAL** | **Отсутствие тестов.** Папка `tests` отсутствует, хотя `pytest` требуется. Скрипты в `scripts` несовместимы с `pytest` без плагинов. | **ОТКРЫТО** |
| **HIGH** | **Некорректная иерархия пакетов.** Отсутствие `__init__.py` в корне и `bot/` мешает работе `mypy` и импортам. | **ЧАСТИЧНО ИСПРАВЛЕНО** |
| **MEDIUM** | **Хранение ключей.** Приватные ключи хранятся в БД в открытом виде (`VPNService.create_profile`). | **РЕКОМЕНДАЦИЯ** |
| **LOW** | **E402** Ошибки импорта в скриптах из-за динамической настройки путей. | **ДОПУСТИМО** |

## 2. Архитектурные дыры

1. **Зависимость от AmneziaWG CLI:** Бот использует стандартную утилиту `wg` для управления сервером. Однако параметры AmneziaWG (`Jc`, `S1` и т.д.) требуют патченной версии `wireguard-tools` (AmneziaWG-tools). Бот никак не проверяет, поддерживает ли бинарный файл `wg`/`awg` эти расширения.
2. **Масштабируемость IP:** Метод `get_next_ipv4` ограничен одной подсетью `/24` и делает полный скан БД при каждом запросе. Это неэффективно при росте базы.
3. **Логирование:** Используется `loguru`, но конфиг в `main.py` удаляет все стандартные логгеры, что может "заглушить" критические сообщения от встроенных библиотек (например, от `aiogram`).

## 3. Результаты тестов

Из-за отсутствия `pytest-asyncio` в чистой среде `uvx` и специфической структуры папки `scripts/` (вместо стандартной `tests/`), классический запуск `pytest` не удался. Ручной анализ скриптов (например, `test_vpn_service.py`) показал, что они жестко привязаны к наличию бинарника `wg` в системе. В среде без установленного WireGuard тесты логики генерации ключей закономерно упадут. Рекомендуется использовать моки (mocks) для тестирования логики без реального `wg`.

## 4. Выполненные фиксы (Патчи)

- **Синтаксис хендлеров:** Полностью переписаны некорректные многострочные конкатенации и f-строки в файлах:
  - `bot/handlers/admin.py`
  - `bot/handlers/monitoring.py`
  - `bot/handlers/onboarding.py`
  - `bot/handlers/profiles.py`
- **Иерархия модулей:** Добавлен `bot/__init__.py` для корректной работы `mypy` и разрешения импортов.

## Заключение
Проект приведен в работоспособное состояние с точки зрения синтаксиса Python. Для полноценного продакшена требуется:
1. Создать полноценный набор тестов в папке `tests/` с использованием моков.
2. Развертывание бота исключительно на сервере с корректно установленным ядром и утилитами AmneziaWG.
3. Реализация шифрования приватных ключей пользователей в базе данных.