---
phase: 01-foundation-data-layer
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified: [bot/db/engine.py, bot/db/models.py, bot/middlewares/db_middleware.py, main.py, scripts/verify_db.py]
autonomous: true
requirements: [DATA-01]
must_haves:
  truths:
    - "База данных bot_data.db создается автоматически при запуске."
    - "Таблицы users, approvals, daily_stats и configs созданы в соответствии со схемой."
    - "Бот успешно инициализируется и выводит сообщение о готовности БД в логах."
    - "Скрипт верификации подтверждает наличие всех таблиц в SQLite."
  artifacts:
    - path: "bot/db/engine.py"
      provides: "Логика подключения к БД и инициализации таблиц"
    - path: "bot/db/models.py"
      provides: "SQL-запросы для создания таблиц"
    - path: "bot/middlewares/db_middleware.py"
      provides: "Middleware для инъекции сессии БД в хендлеры"
    - path: "main.py"
      provides: "Точка входа бота с настройкой middleware и логирования"
    - path: "scripts/verify_db.py"
      provides: "Инструмент проверки целостности БД"
  key_links:
    - from: "main.py"
      to: "bot/db/engine.py"
      via: "инициализация БД при запуске"
      pattern: "init_db"
    - from: "bot/middlewares/db_middleware.py"
      to: "aiosqlite"
      via: "создание асинхронного соединения"
      pattern: "aiosqlite\\.connect"
    - from: "scripts/verify_db.py"
      to: "bot/core/config.py"
      via: "загрузка пути к БД из настроек"
      pattern: "from bot\\.core\\.config import Settings"
---

<objective>
Реализация слоя хранения данных на базе SQLite и асинхронной библиотеки aiosqlite. Создание точки входа бота и механизма внедрения зависимости БД в обработчики.

Цель: Обеспечить персистентность данных и удобный доступ к БД из любой части бота.
Результат: Работающая база данных с необходимой схемой (включая таблицу configs) и базовый запуск бота.
</objective>

<execution_context>
@/home/azagreev/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PHASE_01_RESEARCH.md
@.planning/phases/01-foundation-data-layer/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Реализация слоя работы с БД (Engine & Models)</name>
  <files>bot/db/engine.py, bot/db/models.py</files>
  <action>
    1. В bot/db/models.py определить SQL-запросы для создания таблиц:
       - users (telegram_id, username, full_name, is_admin, is_approved, registered_at)
       - approvals (id, user_id, status, admin_id, updated_at)
       - daily_stats (date, total_users, new_users, approved_count, requests_count)
       - configs (key TEXT PRIMARY KEY, value TEXT) -- Для хранения настроек AmneziaWG и бота
    2. В bot/db/engine.py создать функцию init_db(db_path), которая:
       - Подключается к БД через aiosqlite.
       - Выполняет запросы из models.py.
       - Логирует успешное завершение на русском языке.
    3. Примечание: Процесс инициализации должен зависеть от корректности .env (DB_PATH).
    4. Использовать комментарии в коде на русском языке.
  </action>
  <verify>
    <automated>python3 -c "import asyncio; from bot.db.engine import init_db; asyncio.run(init_db('test.db'))"</automated>
    <manual>Проверить появление файла test.db и наличие всех 4-х таблиц через sqlite3.</manual>
    <sampling_rate>after_task</sampling_rate>
  </verify>
  <done>Логика БД готова, все таблицы (включая configs) инициализируются корректно.</done>
</task>

<task type="auto">
  <name>Точка входа и Middleware для БД</name>
  <files>bot/middlewares/db_middleware.py, main.py</files>
  <action>
    1. Создать bot/middlewares/db_middleware.py:
       - Реализовать класс DbMiddleware(BaseMiddleware).
       - В методе __call__ открывать асинхронное соединение aiosqlite.connect.
       - Устанавливать db.row_factory = aiosqlite.Row.
       - Передавать соединение в data['db'].
    2. Создать main.py:
       - Настроить логирование через loguru или logging.
       - Инициализировать Bot и Dispatcher из aiogram.
       - Убедиться, что .env существует перед запуском (иначе выбросить ошибку).
       - Вызвать init_db() при запуске бота.
       - Зарегистрировать DbMiddleware в диспетчере.
       - Запустить polling.
    3. Комментарии и логи — строго на русском языке.
  </action>
  <verify>
    <automated>python3 -m py_compile main.py</automated>
    <manual>Запустить python3 main.py (при наличии .env) и убедиться, что база создана.</manual>
    <sampling_rate>after_task</sampling_rate>
  </verify>
  <done>Бот запускается, БД подключается через middleware, работа зависит от наличия .env.</done>
</task>

<task type="auto">
  <name>Скрипт верификации базы данных</name>
  <files>scripts/verify_db.py</files>
  <action>
    1. Создать scripts/verify_db.py для проверки структуры БД:
       - Подключается к БД из конфига (загружается из .env).
       - Проверяет наличие таблиц users, approvals, daily_stats, configs через запрос к sqlite_master.
       - Выводит отчет о проверке на русском языке.
    2. Добавить обработку ошибок, если БД не найдена или таблицы отсутствуют.
  </action>
  <verify>
    <automated>python3 scripts/verify_db.py</automated>
    <manual>Убедиться, что скрипт выводит "База данных корректна" и упоминает configs.</manual>
    <sampling_rate>after_task</sampling_rate>
  </verify>
  <done>Скрипт проверки создан и подтверждает целостность БД (включая configs).</done>
</task>

</tasks>

<success_criteria>
1. Файл bot_data.db успешно создается при запуске main.py.
2. Все таблицы (users, configs, approvals, daily_stats) присутствуют в схеме.
3. Бот готов к обработке входящих апдейтов с доступом к БД.
</success_criteria>

<output>
После завершения создать .planning/phases/01-foundation-data-layer/01-02-SUMMARY.md
</output>
