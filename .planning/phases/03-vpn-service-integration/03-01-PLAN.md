---
phase: 03-vpn-service-integration
plan: 03-01
type: execute
wave: 1
depends_on: ["02-01"]
files_modified: [bot/db/models.py, bot/db/engine.py, bot/core/config.py, .env.example, bot/services/vpn_service.py]
autonomous: true
requirements: [VPN-01]
must_haves:
  truths:
    - "Таблица vpn_profiles описана в моделях и создается при инициализации БД."
    - "Класс Settings содержит все необходимые поля для AmneziaWG (jc, s1, s2 и т.д.)."
    - "VPNService содержит асинхронный метод для генерации ключей через CLI."
    - "VPNService проверяет наличие утилиты 'wg' в системе при инициализации."
  artifacts:
    - path: "bot/services/vpn_service.py"
      provides: "Базовый класс VPNService с генерацией ключей"
  key_links:
    - from: "bot/services/vpn_service.py"
      to: "bot/core/config.py"
      via: "Импорт объекта settings"
---

<objective>
Подготовка инфраструктуры для VPN-сервиса: обновление схемы БД, расширение конфигурации и реализация базовой генерации ключей.

Цель: Создать фундамент для управления пирами AmneziaWG.
Результат: Обновленная БД и сервис с возможностью генерации пар ключей.
</objective>

<execution_context>
@/home/azagreev/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PHASE_03_RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Обновление схемы БД и инициализации</name>
  <files>bot/db/models.py, bot/db/engine.py</files>
  <action>
    1. Добавить `CREATE_PROFILES_TABLE` в `bot/db/models.py` с полями: `id`, `user_id`, `name`, `private_key`, `public_key`, `ipv4_address`, `created_at`.
    2. Добавить новую таблицу в список `ALL_TABLES`.
    3. Убедиться, что `init_db` в `bot/db/engine.py` вызывает создание всех таблиц.
  </action>
  <verify>
    <automated>python3 -c "import asyncio; from bot.db.engine import init_db; asyncio.run(init_db()); print('DB updated successfully')"</automated>
    <manual>sqlite3 bot_data.db ".schema vpn_profiles"</manual>
    <sampling_rate>after_task</sampling_rate>
  </verify>
  <done>Таблица vpn_profiles интегрирована в схему.</done>
</task>

<task type="auto">
  <name>Расширение конфигурации AmneziaWG</name>
  <files>bot/core/config.py, .env.example</files>
  <action>
    1. Добавить в `Settings` параметры: `wg_port`, `server_pub_key`, `server_endpoint`, `dns_servers`, `vpn_ip_range`, `wg_interface` (по умолчанию "awg0").
    2. Добавить параметры обфускации: `jc`, `jmin`, `jmax`, `s1`, `s2`, `h1`, `h2`, `h3`, `h4`.
    3. Обновить `.env.example` примерами значений.
  </action>
  <verify>
    <automated>python3 -c "from bot.core.config import settings; assert hasattr(settings, 'jc'), 'Missing AmneziaWG params'"</automated>
    <manual>Проверить .env.example на наличие параметров Jc, S1, S2.</manual>
    <sampling_rate>after_task</sampling_rate>
  </verify>
  <done>Конфигурация готова к работе с AmneziaWG.</done>
</task>

<task type="auto">
  <name>Реализация базового VPNService и генерации ключей</name>
  <files>bot/services/vpn_service.py</files>
  <action>
    1. Создать `bot/services/vpn_service.py`.
    2. Реализовать проверку наличия `wg` в системе в методе `__init__` или при первом вызове.
    3. Реализовать `VPNService.generate_keys()` с использованием `asyncio.create_subprocess_exec` для вызова `wg genkey` и `wg pubkey`.
    4. Добавить логирование процесса.
  </action>
  <verify>
    <automated>python3 -c "import asyncio; from bot.services.vpn_service import VPNService; priv, pub = asyncio.run(VPNService.generate_keys()); assert priv and pub, 'Key generation failed'"</automated>
    <manual>Проверить логи бота на наличие записей о генерации ключей.</manual>
    <sampling_rate>after_task</sampling_rate>
  </verify>
  <done>Сервис может генерировать пары ключей WireGuard и проверяет окружение.</done>
</task>

</tasks>

<success_criteria>
1. Таблица vpn_profiles существует в БД.
2. Конфигурация AmneziaWG успешно загружается.
3. Ключи генерируются программно через вызов CLI.
</success_criteria>

<output>
После завершения создать .planning/phases/03-vpn-service-integration/03-01-SUMMARY.md
</output>
