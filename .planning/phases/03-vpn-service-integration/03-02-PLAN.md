---
phase: 03-vpn-service-integration
plan: 03-02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [bot/services/vpn_service.py, scripts/test_vpn_service.py]
autonomous: true
requirements: [VPN-01]
must_haves:
  truths:
    - "VPNService умеет генерировать .conf строку AmneziaWG."
    - "Профили создаются и сохраняются в БД с инкрементальным IP."
    - "Бот применяет публичный ключ пира к интерфейсу сервера через 'wg set'."
    - "Интеграционный тест проходит без ошибок."
  artifacts:
    - path: "scripts/test_vpn_service.py"
      provides: "Скрипт для итоговой верификации всей логики Phase 3"
  key_links:
    - from: "bot/services/vpn_service.py"
      to: "bot/db/engine.py"
      via: "Методы сохранения профиля в SQLite"
---

<objective>
Завершение интеграции VPN-сервиса: реализация управления IP-адресами, генерации конфигурационных файлов, создания полноценных профилей и синхронизации с сервером.

Цель: Обеспечить бота возможностью создавать и активировать VPN-профили.
Результат: Полностью рабочий VPNService с интеграционным тестом.
</objective>

<execution_context>
@/home/azagreev/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PHASE_03_RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Реализация управления IP-адресами</name>
  <files>bot/services/vpn_service.py</files>
  <action>
    1. Добавить в `VPNService` асинхронный метод `get_next_ipv4()`.
    2. Метод должен искать максимальный IP в `vpn_profiles` и инкрементировать последний октет.
    3. Если база пуста, использовать `10.8.0.2` (или значение из `vpn_ip_range`).
  </action>
  <verify>
    <automated>python3 -c "import asyncio; from bot.services.vpn_service import VPNService; ip = asyncio.run(VPNService.get_next_ipv4()); assert '10.8.0' in ip, 'IP management failed'"</automated>
    <manual>sqlite3 bot_data.db "SELECT ipv4_address FROM vpn_profiles ORDER BY id DESC LIMIT 1;"</manual>
    <sampling_rate>after_task</sampling_rate>
  </verify>
  <done>Автоматическое выделение IP реализовано.</done>
</task>

<task type="auto">
  <name>Генерация конфига и синхронизация с сервером</name>
  <files>bot/services/vpn_service.py</files>
  <action>
    1. Реализовать `VPNService.generate_config_content(private_key, ipv4)`.
    2. Построить строку .conf файла в формате AmneziaWG с использованием параметров из `settings`.
    3. Реализовать асинхронный метод `sync_peer_with_server(public_key, ipv4)`.
    4. Метод должен вызывать `wg set <interface> peer <public_key> allowed-ips <ipv4>/32` через `asyncio.create_subprocess_exec`.
  </action>
  <verify>
    <automated>python3 -c "import asyncio; from bot.services.vpn_service import VPNService; conf = VPNService.generate_config_content('priv', '10.8.0.2'); assert 'PrivateKey' in conf and 'Jc' in conf, 'Config format invalid'"</automated>
    <manual>Проверить, что строка .conf содержит все поля AmneziaWG (Jc, S1, S2 и т.д.).</manual>
    <sampling_rate>after_task</sampling_rate>
  </verify>
  <done>Функционал генерации конфига и синхронизации с интерфейсом реализован.</done>
</task>

<task type="auto">
  <name>Создание профиля и интеграционный тест</name>
  <files>bot/services/vpn_service.py, scripts/test_vpn_service.py</files>
  <action>
    1. Реализовать асинхронный метод `create_profile(user_id, name)`.
    2. Метод должен: генерировать ключи, выбрать IP, вызвать `sync_peer_with_server` и записать в БД.
    3. Создать `scripts/test_vpn_service.py` для полной проверки процесса.
    4. Скрипт должен имитировать создание профиля и выводить конфиг.
  </action>
  <verify>
    <automated>python3 scripts/test_vpn_service.py</automated>
    <manual>Убедиться, что в выводе теста присутствуют корректные ключи и инкрементированный IP.</manual>
    <sampling_rate>after_task</sampling_rate>
  </verify>
  <done>Интеграционный тест подтверждает полную работоспособность Phase 3.</done>
</task>

</tasks>

<success_criteria>
1. Бот корректно выделяет уникальные IP.
2. Новые профили сохраняются в БД.
3. Бот применяет пиры к серверу через CLI.
4. Генерируется валидный .conf файл AmneziaWG.
</success_criteria>

<output>
После завершения создать .planning/phases/03-vpn-service-integration/03-02-SUMMARY.md
</output>
